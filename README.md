# CosmoHubAPI
API для подготовки студентов к региональному этапу чемпионата "Профессионалы 2025".

## Карта документации
1. [Установка](#установка)  
   1.1. [Требования](#требования)    
   1.2. [Установка PHP](#установка-php)  
   1.3. [Установка Composer](#установка-composer)  
   1.4. [Установка Laravel](#установка-laravel)  
   1.5. [Настройка .env](#натстройка-.env)  
   1.6. [Запуск локального сервера](#запуск-локального-сервера)

3. [Развертывание API](#развертывание-api)

4. [Основы Laravel](#основы-laravel)  
   3.1. [Миграции](#миграции)  
   3.2. [Модели](#модели)    
   3.3. [Контроллеры и их взаимодействие с моделями](#контроллеры-и-их-взаимодействие-с-моделями)  
   3.4. [API роуты для работы с базой данных](#api-роуты-для-работы-с-базой-данных)
   3.5. [Сидеры](#сидеры)

## Установка

### Требования

Для запуска проекта требуется версия PHP не ниже 8.2, MySQL 8.0, Composer 2.8.5 и Laravel 11.  
PHP требует расширения(обычно предустановлено по умолчанию) GD.  
Laravel требует расширения Passport. Его установка будет описана в пункте [развертывание API](#развертывание-api).

### Установка PHP

Для установки PHP необходимо перейти на [официальный сайт](https://www.php.net/downloads.php). Оттуда скачиваем PHP-8.2 или выше. Обязательно проверям, чтобы PHP был добавлен в переменные среды.

### Установка Composer

Для установки Composer необходимо перети на [официальный сайт](https://getcomposer.org/download/). На сайте выбираем утсановщик для Windows.  
На одном из этапов необходимо обязательно выбрать PHP, который был записал в переменные среды. Если вашей версии PHP нет, нужно добавить его в переменные среды и перезапустить установщик. Далее соглашаемся со всеми пунктами установки и завершаем её.  
Если откроем терминал и пропишем ```composer``` должны вывестить команды Composer. Если же вы получили ошибку, скорее всего, Composer не был добавлен в переменные среды автоматически.

### Установка Laravel

Детально можно посмотреть этот процесс в [официальной документации](https://laravel.com/docs/11.x/installation). Документация сделана очень удобно, поэтому в ней можно найти ответ почти на любой вопрос.

1. Глобально добавим Laravel в Composer:
```
composer global require laravel/installer
```
Дальнейшие пункты опциональны, если вы просто хотите [развернуть](#развертывание-api) данный проект.

2. Создадим каталог для нашего проекта
   При желании можно использовать OpenServer, тогда установка немного изменится, но основные этапы останутся теми же.

3. Откроем терминал в созданном каталоге и создадим новый проект:
```
laravel new [название-проекта]
```

4. В соответсвии с вашими предпочтениями выбираем настройки проекта
   В случае с данным проектом мы используем стандартную конфигурацию Laravel, БД - MySQL, для тестирования - PHPUnit. Миграции не запускаем.

В чистом проекте можно удалить стандартную миграцию ```create_users_table``` в каталоге ```database/migrations```, а также модель ```User.php``` в каталоге ```App/Models```.

Отлично! Мы успешно скачали и создали новый проект Laravel!

### Настройка .env

Для подключения к БД нам необходимо настроить .env файл. Он находится в каталоге созданного проекта.  
.env файлы не стоит добавлять в репозиторий, поэтому нужно переименовать файл ```.env.example``` в ```.env``` и открыть его.

В файле нужно найти строки ниже и изменить их в соответсвии с вашей ситуацией.

```
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=название_базы_данных
DB_USERNAME=root
DB_PASSWORD=
```

Для БД в PHPMyAdmin через OpenServer строки будут выглядеть примерно так:

```
DB_CONNECTION=mysql
DB_HOST=MySQL-8.0
DB_PORT=3306
DB_DATABASE=название_базы_данных
DB_USERNAME=root
DB_PASSWORD=
```

### Запуск локального сервера

Есть 2 способа запуска локального сервера для Laravel:
1. Открываем терминал и прописываем следующую команду:
```
php artisan serve
```

В терминале выведется адресс, по которому будет доступен ваш проект.  
Для завершения работы сервера нажмите ```ctrl + c```.

2. Через локальный сервер:
   Если ваш локальный сервер правильно настроен, подключившись к нему, ваш проект уже будет работать.

Вам откроется главная страница вашего Laravel-приложения. На ней могут отображаться ошибки, если вы неправильно подключили базу данных, или миграции не были выполнены.  
Для выполнения миграции таблиц в базу данных командой:
```
php artisan migrate
```

## Развертывание API

Для того, чтобы запустить API из данного проекта вам необходимо установить необходимые зависимости.

Для аутентификации используется [Laravel Passport](https://laravel.com/docs/11.x/passport#main-content). Для его установки в проект нужно прописать команду:
```
php artisan install:api --passport
```

Теперь запустим миграции командой:
```
php artisan migrate
```

Далее нам нужно получить ключи, чтобы аутентификация работала. Это делается командой:
```
php artisan passport:client --personal
```

Теперь заполним базу данных стоковыми данными. Для этого запустим все сидеры командой:
```
php artisan db:seed
```

На этом API развёрнуто на вашем локальном сервере. Необходимо только запустить его и проверить, что всё работает.

## Основы Laravel

### Миграции

([Из документации](https://laravel.com/docs/11.x/migrations#main-content)):  
Миграции - это как контроль версий для вашей базы данных, позволяющий вашей команде определять и совместно использовать определение схемы базы данных приложения. Если вам когда-нибудь приходилось говорить членам команды, чтобы они вручную добавили столбец в локальную схему базы данных после внесения изменений из системы контроля исходного кода, вы сталкивались с проблемой, которую решают миграции баз данных.

Для создания миграции используется команда:
```
php artisan make:migrate [название-миграции]
```

В каталоге ```database/migrations``` появитсья новая миграция.

В миграции есть 2 функции: ```up()``` и ```down()```. Они отвечают за применение и откат миграции соответсвенно.

Для создания новой таблицы в БД создаём следующую структуру:
```
public function up(): void
{
    Schema::create('[название_таблицы]', function (Blueprint $table) {
        $table->id();            // ID записи
        $table->timestamps();    // Временные метки создания и обновления записи в БД
    });
}
```

Названия таблиц и полей в базах данных принято писать в формате snake_case.

Создадим новые поля в БД:
```
public function up(): void
{
    Schema::create('users', function (Blueprint $table) {
        $table->id();               // ID записи
        $table->string('name');     // Строковое поле для имени пользователя
        $table->string('email');    // Уникальное строковое поле ввода для email
        $table->timestamps();       // Временные метки создания и обновления записи в БД
    });
}
```

В функции ```down()``` описывается процесс удаления таблицы:
```
public function down(): void
{
    Schema::dropIfExists('crew_members');
}
```

Для выполнения миграции пропишем команду:
```
php artisan migrate
```

Если вы хотите откатить последнюю миграцию используйте команду:
```
php artisan migrate:rollback
```

### Модели

Модели в Laravel — это компоненты, представляющие данные приложения и логику их обработки. Они являются частью архитектуры MVC (Model-View-Controller) и используют Eloquent ORM для взаимодействия с базой данных.

Для создания модели используем команду:
```
php artisan make:model User
```

Модели принято называть в формате PascalCase.

После этого в каталоге ```App/Models``` появится новая модель ```User.php```. В неё мы пропишем поля, которые можно будет заполнять:
```
class User extends Model
{
    use HasFactory;

    // Добавляем возможность заполнять поля
    protected $fillable = [
        'name',
        'email,
    ];
}
```

Также в моделях мы можем прописывать связь с другими таблицами, например:
```
// Связь с моделью Booking
public function bookings() {
    return $this->hasMany(Booking::class);
}
```

### Контроллеры и их взаимодействие с моделями

([Из документации](https://laravel.com/docs/11.x/migrations#main-content)):   
Контроллеры позволяют сгруппировать логику обработки запросов в одном классе.

Создадим контроллер для нашего пользователя. Также, как и с моделями, для нейминга используем PascalCase:
```
php artisan make:controller UserController
```

После этого у вас появиться созданный контроллер в каталоге ```App/Http/Controllers```. В нём создадим функцию, которая будет возвращать JSON ответ сервера со всеми пользователями.
```
use Illuminate\Http\Request;
use App\Models\User;            // Подключаем модель пользователя

class UserController extends Controller
{
    // Функция для получения информации о пользователяз
    public function index() {
        // Получаем данные из базы
        $users = User::all();

        // Группируем полученные данные в переменную
        $data = $users->map(function ($user){
            return [
                'name' => $user->name,
                'email' => $user->email
            ];
        });

        // Возвращаем ответ сервера в виде JSON с статусом 200
        return response()->json($data, 200);
    }
}
```

// TODO: Добавить создание пользователя

### API роуты для работы с базой данных

Роуты(маршруты) позваляют взаимодействовать с нашим API при помощи браузера. Но обычно для тестирования Backend-разработчики используют Postman.

Роуты для API нужно писать в файле ```routes/api.php```. Изначально этого файла нет, но при установке Laravel Passport он появляется.

Маршруты имеют разные типы:
1. Get - получение
2. Post - отправка
3. Patch - изменение
4. Delete - удаление

Создадим маршрут для получения всех пользователей:
```
use App\Http\Controllers\UserController;

Route::get('/users', [UserController::class, 'index']);
```

Теперь наш роут доступен по адресу ```{ваш_хост}/users```.

Пояснения к параметрам роута:
```
Route::get('/адрес_по_которому_доступен_роут', [название_контроллера::class, 'название_вызываемой_функции']);
```
